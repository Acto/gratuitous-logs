"use strict";

/*eslint-env browser*/
/*global $, _ */

var isChange = false;
var commonmark = window.commonmark;
var writer = new commonmark.HtmlRenderer({ sourcepos: true });
var reader = new commonmark.Parser();


function convertMarkDownToHtml() {
    console.log(isChange);
    if(isChange){
        var textarea = $("#input-contents");

        // parse処理
        var startTime = new Date().getTime();
        var parsed = reader.parse(textarea.val());
        var endTime = new Date().getTime();
        var parseTime = endTime - startTime;
        $("#parsetime").text(parseTime);

        // render処理
        startTime = new Date().getTime();
        $("#posts-preview").html(writer.render(parsed));
        endTime = new Date().getTime();
        var renderTime = endTime - startTime;
        $("#rendertime").text(renderTime);

        // Syntax Highlight (Use "highlight.js")
        $('pre code').each(function(i, block) {
            hljs.highlightBlock(block);
            // lineNumbersBlock(block);
        });

        // Textarea と Preview要素の高さをそろえる
        var currentPreviewHeight = $("td#posts-preview").height();
        var currentTextareaHeight =  $("td#posts-textarea textarea").height();

        if(currentPreviewHeight > currentTextareaHeight-14){
            $("td#posts-textarea textarea").height(currentPreviewHeight-14);
        }

        isChange = false;
    }
}

function lineNumbersBlock (element) {
    if (typeof element !== 'object') return;

    var parent = element.parentNode;
    var lines = getCountLines(parent.textContent);
    var nbsp = String.fromCharCode( 160 );

    if (lines > 1) {
        var l = '';
        for (var i = 0; i < lines; i++) {
            l += (nbsp+nbsp+i).slice(-3) + '\n';
        }

        var linesPanel = document.createElement('code');
        linesPanel.className = 'hljs hljs-line-numbers';
        linesPanel.style.float = 'left';
        linesPanel.style.textAlign = 'right';
        linesPanel.textContent = l;

        parent.insertBefore(linesPanel, element);
    }
}

function getCountLines(text) {
    if (text.length === 0) return 0;

    var regExp = /\r\n|\r|\n/g;
    var lines = text.match(regExp);
    lines = lines ? lines.length : 0;

    // 最終行に改行がある場合、+1する
    if (!text[text.length - 1].match(regExp)) {
        lines += 1;
    }

    return lines;
}


$(document).ready(function(){

    $('#article-tags').tagit({
        fieldName: 'post[tag_list]',
        singleField: true,
        availableTags: window.available_tag_list,
        placeholderText: 'TAGS separated by commas'
    });

    if(tag_list.length > 0){
        for(var tag in tag_list){
          $('#article-tags').tagit('createTag', tag);
        }
    }

    if($('#input-contents').val() != ''){
        isChange = true;
        convertMarkDownToHtml();
    }

    // 半角英数の入力を検知
    $('#input-contents').keypress(function() {
        isChange = true;
        convertMarkDownToHtml();
    });
    // deleteキーとbackspaceキーの入力を検知
    $('#input-contents').keyup(function(e) {
        if (e.keyCode == 46 || e.keyCode == 8){
            isChange = true;
            convertMarkDownToHtml();
        }
    });

});

